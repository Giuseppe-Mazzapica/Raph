/**
 * Part of Raph WordPress plugin
 * Author: Giuseppe Mazzapica <giuseppe.mazzapica@gmail.com>
 * License: MIT
 */
!function(e,n,t,o,a){"use strict";t.methods={},t.backup={},t.info={},t.methods.updateEditor=function(e){if(t.info.whileRendering)return!1;var n=t.methods.getContent(e);-1!==n.content.search(/\[.+\]/)?n.isSelection?t.methods.render(e,n.content,n.isSelection):e.windowManager.confirm(t.i18n.confAll,function(o){o&&t.methods.render(e,n.content,n.isSelection)}):t.methods.htmlNotice(t.i18n.noShortcodes,"error")},t.methods.getContent=function(e){var n,o;return e.selection.isCollapsed()?(n=e.getContent(),o=!1):(n=e.selection.getContent(),o=!0,t.info.currentSelection=n),{content:n,isSelection:o}},t.methods.render=function(n,o,a){t.methods.startRendering(n),t.methods.backup(n,n.getContent()),e("#raph-notice").length&&e("#raph-notice").remove(),t.methods.ajaxCall(o).done(function(e){t.methods.ajaxDone(e,n,a)}).fail(function(){t.methods.htmlNotice(t.i18n.ajaxError,"error"),t.backup={}}).always(function(){t.methods.endRendering(n)})},t.methods.ajaxCall=function(n){return e.ajax({type:"POST",url:o,dataType:"json",cache:!1,data:{action:"raph-render",pid:t.data.pid,type:t.data.type,raphCheck:t.data.raphCheck,content:n}})},t.methods.ajaxDone=function(e,n,o){if(e.success&&e.data.content){if(o&&n.selection.getContent()!==t.info.currentSelection)return t.backup={},!1;o?n.selection.setContent(e.data.content):n.setContent(e.data.content);var a=t.i18n.notice;a+=' <a id="raph-restore" href="#wp-content-wrap">'+t.i18n.restore+"</a>",t.methods.htmlNotice(a,"updated"),n.onChange.add(function(){t.backup.editor&&(t.backup.changed=!0)})}else t.methods.htmlNotice(t.i18n.ajaxError,"error"),t.backup={}},t.methods.htmlNotice=function(n,t){e("#wp-content-wrap").prepend('<div id="raph-notice" class="'+t+'"><p>'+n+"</p></div>"),"error"===t&&setTimeout(function(){e("#raph-notice").remove()},5e3)},t.methods.backup=function(e,n){t.backup.editor=e,t.backup.content=n,t.backup.changed=!1},t.methods.restoreContentConfirm=function(){if(t.backup.editor){var e=!t.backup.changed;e?t.methods.restoreContent():t.backup.editor.windowManager.confirm(t.i18n.conf1+"\n"+t.i18n.conf2,function(){t.methods.restoreContent()})}},t.methods.restoreContent=function(){t.backup.editor&&(t.backup.editor.setContent(t.backup.content),e("#raph-notice").remove(),t.backup={})},t.methods.startRendering=function(e){var n=e.controlManager.buttons.raphRender;n.icon("raph dashicons-clock"),n.disabled(!0),t.info.whileRendering=!0},t.methods.endRendering=function(e){var n=e.controlManager.buttons.raphRender;n.icon("raph dashicons-admin-appearance"),n.disabled(!1),t.info={}},n.PluginManager.add("raphRender",function(e){e.addButton("raphRender",{title:t.i18n.buttonTitle,icon:"raph dashicons-admin-appearance",onclick:function(){t.methods.updateEditor(e)}})}),e(a).on("click","#raph-restore",function(e){e.preventDefault(),t.methods.restoreContentConfirm()})}(jQuery,tinymce,Raph,ajaxurl,document);